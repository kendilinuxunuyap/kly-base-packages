#!/usr/bin/env bash
version="2.39"
name="glibc"
depends=""
description="temel kütüphane"
source="https://ftp.gnu.org/gnu/libc/${name}-${version}.tar.gz"

groups="sys.base"
export CC="gcc"
    export CXX="g++"
   #	cd $SOURCEDIR
   # mkdir glibc-build
   # cd glibc-build
  
setup()
{

	cp -prvf $PACKAGEDIR/files /tmp/kly/build/
	
	opts=(
        --prefix=/usr
        --mandir=/usr/share/man
        --infodir=/usr/share/info
        --enable-bind-now
        --enable-multi-arch
        --enable-stack-protector=strong
        --enable-stackguard-randomization
        --disable-crypt
        --disable-profile
        --disable-werror
        --enable-static-pie
        --enable-static-nss
        --disable-nscd
    )

    
      	echo "slibdir=/lib64" >> configparms
    	echo "rtlddir=/lib64" >> configparms
    	
    	../${name}-${version}/configure ${opts[@]} \
        --host=x86_64-pc-linux-gnu \
        --libdir=/lib64 \
        --libexecdir=/lib64/glibc
   
	
}
build()
{
    make -j5 #-C $DESTDIR all

}
package()
{
	#cd $SOURCEDIR
	# create symlink lib64 (gentoo compability)
	mkdir -p ${DESTDIR}/lib64
	cd $DESTDIR
	ln -s lib64 lib
	cd $BUILDDIR
	
    make install DESTDIR=$DESTDIR 

    mkdir -p ${DESTDIR}/etc/ld.so.conf.d/ ${DESTDIR}/etc/sysconf.d/ ${DESTDIR}/bin
    install ../files/ld.so.conf ${DESTDIR}/etc/ld.so.conf
    install ../files/usr-support.conf ${DESTDIR}/etc/ld.so.conf.d/
    install ../files/x86_64-linux-gnu.conf ${DESTDIR}/etc/ld.so.conf.d/
    # remove ld.so.cache file (this file must generated by ldconfig command from ymp)
    rm -f ${DESTDIR}/etc/ld.so.cache
    # install sysconf trigger
    
    install ../files/glibc.sysconf ${DESTDIR}/etc/sysconf.d/glibc
    # install extra tools
    install ../files/locale-gen ${DESTDIR}/bin/locale-gen
    install ../files/revdep-rebuild ${DESTDIR}/bin/revdep-rebuild
    # replace buggy turkish format with better one
    install ../files/tr_TR ${DESTDIR}/usr/share/i18n/locales/tr_TR
    # remove unused languages
    for l in ku hy ; do
        rm -rf ${DESTDIR}/usr/lib/locale/${i}_*
        rm -rf ${DESTDIR}/usr/share/locale/${i}_*
        rm -rf ${DESTDIR}/usr/share/i18n/locales/${i}_*
    done
    # fix ldd shebang
    sed -i "s|#!/bin/bash|#!/bin/sh|g" ${DESTDIR}/usr/bin/ldd
   
   cd ${DESTDIR}/lib64/
   mkdir -p x86_64-linux-gnu
   cd x86_64-linux-gnu
     while read -rd '' file; do
       ln -s $file $(basename "$file")
   done< <(find "../"  -maxdepth 1 -type f -iname "*" -print0)
     
    
}


